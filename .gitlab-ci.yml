# yamllint disable

# deps
include:
- template: Security/Secret-Detection.gitlab-ci.yml
# - template: Security/License-Scanning.gitlab-ci.yml
- template: Terraform.latest.gitlab-ci.yml
- project: 'renovate-bot/renovate-runner'
  file: '/templates/renovate-dind.gitlab-ci.yml'

renovate:
  only:
    - schedules
    - pushes


# Secrets Detection
.secret-analyzer:
  stage: 💨 smoke test


.init: &init
  stage: 🛠️ prep
  rules:
    - changes:
        - clusters/lin/dal/iac/**/*
  parallel:
    matrix:
      - TF_ROOT: ["clusters/lin/dal/iac"]



.validate: &validate
  stage: 💨 smoke test
  rules:
    - changes:
        - clusters/lin/dal/iac/**/*
  parallel:
    matrix:
      - TF_ROOT: ["clusters/lin/dal/iac"]



.tf_lint: &tf_lint
  rules:
    - changes:
        - clusters/lin/dal/iac/**/*
  stage: ✨ lint
  script: terraform fmt -diff -check


.build: &build
  stage: 👀 plan
  rules:
    - changes:
      - clusters/lin/dal/iac/**/*
  artifacts:
    public: false
    reports:
      terraform: ${TF_ROOT}/plan.json
    paths:
      - ${TF_ROOT}/plan.json
  parallel:
    matrix:
      - TF_ROOT: ["clusters/lin/dal/iac"]

.tf_lint_pr: &tf_lint_pr
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - clusters/lin/dal/iac/**/*
  stage: ✨ lint
  script: terraform fmt -diff -check

.deploy: &deploy
  only:
    variables:
      - $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    changes:
        - clusters/lin/dal/iac/**/*
  stage: 🚀 deploy
  when: manual
  script:
    - cd ${TF_ROOT}
    - gitlab-terraform init
    - gitlab-terraform -chdir=$PWD apply -input=false -auto-approve

  parallel:
    matrix:
      - TF_ROOT: ["clusters/lin/dal/iac"]


stages:
  - 💨 smoke test
  - 🛠️ prep
  - ✨ lint
  - 👀 plan
  - 🚀 deploy
