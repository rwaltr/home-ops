#!/usr/bin/env bash
#MISE description="Create and auto-install uCore VM"
#MISE arg "[hostname]" help="Host to install (default: mouse)"
#MISE depends=["ucore:build", "ucore:download-iso"]

set -euo pipefail

HOSTNAME="${1:-mouse}"
VM_DIR="${MISE_PROJECT_ROOT}/.vm"
CUSTOM_ISO_PATH="${VM_DIR}/fedora-coreos-${HOSTNAME}-autoinstall.iso"
DISK_PATH="${VM_DIR}/ucore-${HOSTNAME}.qcow2"
ZFS_DISK_PATH="${VM_DIR}/ucore-${HOSTNAME}-zfs.qcow2"
VM_NAME="ucore-${HOSTNAME}-test"

create_disks() {
    if [ ! -f "${DISK_PATH}" ]; then
        echo "Creating main disk (40GB)..."
        qemu-img create -f qcow2 "${DISK_PATH}" 40G
        echo "✓ Created ${DISK_PATH}"
    else
        echo "✓ Main disk already exists"
    fi
    
    if [ ! -f "${ZFS_DISK_PATH}" ]; then
        echo "Creating ZFS disk (20GB)..."
        qemu-img create -f qcow2 "${ZFS_DISK_PATH}" 20G
        echo "✓ Created ${ZFS_DISK_PATH}"
    else
        echo "✓ ZFS disk already exists"
    fi
}

check_virsh() {
    if ! command -v virsh &> /dev/null; then
        echo "Error: virsh not found. Install libvirt:"
        echo "  Arch: sudo pacman -S libvirt virt-manager"
        echo "  Fedora: sudo dnf install libvirt virt-manager"
        echo "  Ubuntu: sudo apt install libvirt-daemon-system virt-manager"
        exit 1
    fi
    
    if ! virsh --connect qemu:///system list --all &> /dev/null; then
        echo "Error: Cannot connect to libvirt system. Make sure libvirtd is running:"
        echo "  sudo systemctl start libvirtd"
        echo ""
        echo "Note: Using system connection requires sudo for some operations."
        exit 1
    fi
    
    echo "✓ libvirt is available (system mode)"
}

destroy_existing_vm() {
    if virsh --connect qemu:///system list --all | grep -q "${VM_NAME}"; then
        echo "Cleaning up existing VM..."
        virsh --connect qemu:///system destroy "${VM_NAME}" 2>/dev/null || true
        virsh --connect qemu:///system undefine "${VM_NAME}" --nvram 2>/dev/null || true
        echo "✓ Removed existing VM"
    fi
}

echo "==================================="
echo "uCore VM: ${HOSTNAME}"
echo "==================================="
echo ""

echo "Creating custom ISO for ${HOSTNAME}..."
mise run ucore:customize-iso "${HOSTNAME}"

echo ""
create_disks
check_virsh
destroy_existing_vm

echo ""
echo "Creating and starting VM: ${VM_NAME}"
echo ""

virt-install \
    --connect qemu:///system \
    --name "${VM_NAME}" \
    --memory 4096 \
    --vcpus 2 \
    --os-variant fedora-coreos-stable \
    --disk "path=${DISK_PATH},format=qcow2,bus=virtio" \
    --disk "path=${ZFS_DISK_PATH},format=qcow2,bus=virtio" \
    --network network=default,model=virtio \
    --graphics spice,listen=127.0.0.1 \
    --console pty,target_type=serial \
    --noautoconsole \
    --cdrom "${CUSTOM_ISO_PATH}" \
    --boot cdrom,hd

echo ""
echo "✓ VM created and installation started"
echo ""
echo "Installation process:"
echo "  1. Fedora CoreOS installs to /dev/vda (1-2 min)"
echo "  2. System reboots and applies Ignition config"
echo "  3. System rebases to uCore (5-10 min)"
echo "  4. System reboots into uCore"
echo "  5. All services start automatically"
echo ""
echo "Opening virt-manager GUI..."
virt-manager --connect qemu:///system --show-domain-console "${VM_NAME}" &

echo ""
echo "Monitor via GUI (opened) or console:"
echo "  virsh --connect qemu:///system console ${VM_NAME}"
echo ""
