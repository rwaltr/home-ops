# Moltbot on Vultr with uCore

## Overview

Deploy Moltbot (formerly Clawdbot) as a self-hosted AI agent platform on Vultr, running on Universal Blue uCore (immutable Fedora Atomic).

**Key Constraints:**
- OS is immutable (uCore) - cannot modify root filesystem
- AI agent works in a sandbox (Podman containers)
- Infrastructure as Code for quick rebuild/restore
- Pay-as-you-go friendly (shutdown/restore capability)

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Vultr VM (uCore)                                 │
│              Fedora CoreOS → Rebase to uCore on first boot          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   Tailscale (built-in to uCore)                                     │
│   └─ Auth key generated by Pulumi                                   │
│   └─ SSH access: ssh core@moltbot.<tailnet>.ts.net                  │
│                                                                      │
│   Systemd Services (Podman Quadlet):                                │
│                                                                      │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │         moltbot-gateway.service                              │   │
│   │                                                              │   │
│   │   Image: docker.io/clawdbot/clawdbot:latest                 │   │
│   │   Purpose: Gateway process, manages Discord, spawns sandbox │   │
│   │                                                              │   │
│   │   Mounts:                                                    │   │
│   │   - /var/moltbot/state     → /home/node/.clawdbot           │   │
│   │   - /var/moltbot/workspace → /home/node/clawd               │   │
│   │   - /run/podman/podman.sock → /var/run/docker.sock          │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              │ Gateway spawns sandbox containers     │
│                              ▼                                       │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │              Sandbox Containers (dynamic, ephemeral)         │   │
│   │                                                              │   │
│   │   Image: clawdbot-sandbox-common:bookworm-slim              │   │
│   │   Contains: Node 22, Go, Rust, 1Password CLI, common tools  │   │
│   │   Network: bridge (full internet access)                    │   │
│   │   Workspace: /var/moltbot/projects mounted                  │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│   Backup Services:                                                  │
│   - moltbot-backup.timer    (hourly backup to B2)                   │
│   - moltbot-shutdown-backup (backup on shutdown)                    │
│   - moltbot-restore         (restore on first boot if empty)        │
│                                                                      │
│   /var/moltbot/ (VM local storage)                                  │
│   ├── state/           # ~/.clawdbot - config, credentials          │
│   ├── workspace/       # ~/clawd - AGENTS.md, SOUL.md, memory       │
│   └── projects/        # Agent sandbox work directory               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Technology Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| **OS** | uCore | Immutable, Podman + Quadlet built-in, Tailscale pre-installed |
| **Container Management** | Quadlets | Native systemd integration, consistent with uCore patterns |
| **Channel** | Discord | Bot token auth (no QR scan), fully automatable |
| **Backup Storage** | Backblaze B2 | ~$0.01/mo vs Vultr's $18/mo minimum |
| **Secrets** | 1Password | Single vault, single service account for Pulumi + runtime |
| **IaC** | Pulumi (TypeScript) | Generates Tailscale key, B2 bucket, fetches 1Password secrets |

## Cost Summary

| Component | Monthly Cost |
|-----------|-------------|
| Vultr VM (1 vCPU, 2GB RAM, 55GB NVMe) | ~$12.00 |
| Backblaze B2 (~1GB storage) | ~$0.01 |
| B2 egress (daily restarts worst case) | ~$0.27 |
| **Total** | **~$12/mo** |

## Secrets Management

### 1Password Vault Structure

```
1Password Vault: "moltbot"
│
├── [Startup Secrets - fetched by Pulumi at deploy]
│   ├── Discord Bot Token           # Gateway connects to Discord
│   └── Anthropic API Key           # Agent LLM access
│
├── [Runtime Secrets - fetched by agent via op CLI]
│   ├── GitHub Token - Moltbot      # For PRs, repo access, credential requests
│   └── ... other service creds     # As needed
│
└── [Generated via PR workflow]
    └── (Credentials created by automation after agent PRs)

Service Account: "moltbot"
└── Read access to moltbot vault
└── Used by both Pulumi (deploy) and agent (runtime)
```

### Secret Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Deploy Time (Pulumi)                          │
├─────────────────────────────────────────────────────────────────────┤
│  1Password ──► Pulumi ──► Ignition Config ──► VM boots              │
│  (moltbot vault)         (startup secrets)    (gateway starts)      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                     Runtime - Existing Credentials                   │
├─────────────────────────────────────────────────────────────────────┤
│  User: "Deploy my app to AWS"                                       │
│  Agent: op read "op://moltbot/AWS Access Key/credential"            │
│  1Password ──► op CLI ──► Agent has credentials ──► Task done       │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                     Runtime - New Credential Request                 │
├─────────────────────────────────────────────────────────────────────┤
│  User: "I need a new token for project X"                           │
│  Agent: Creates PR in home-ops repo (credential request)            │
│  GitHub Actions ──► Generates credential ──► Populates 1Password    │
│  Agent: op read "op://moltbot/Token - Project X/credential"         │
└─────────────────────────────────────────────────────────────────────┘
```

### Pulumi Secret Sources

| Secret | Source | Purpose |
|--------|--------|---------|
| `TAILSCALE_AUTHKEY` | Pulumi Tailscale provider (generated) | VM joins tailnet |
| `DISCORD_BOT_TOKEN` | 1Password `moltbot` vault | Gateway connects to Discord |
| `ANTHROPIC_API_KEY` | 1Password `moltbot` vault | Agent LLM access |
| `B2_KEY_ID` | Pulumi B2 provider (generated) | Backup credentials |
| `B2_APPLICATION_KEY` | Pulumi B2 provider (generated) | Backup credentials |
| `OP_SERVICE_ACCOUNT_TOKEN` | Pulumi config | Agent runtime 1Password access |

## Infrastructure Components

### Pulumi Stack: `infra/pulumi/vultr/`

**Language:** TypeScript

```typescript
import * as vultr from "@ediri/vultr";
import * as tailscale from "@pulumi/tailscale";
import * as backblaze from "@pulumi/backblaze";
import * as onepassword from "@1password/pulumi-onepassword";

// 1Password - Fetch secrets from moltbot vault
const moltbotVault = onepassword.getVaultOutput({ name: "moltbot" });
const discordToken = onepassword.getItemOutput({
    vault: moltbotVault.uuid,
    title: "Discord Bot Token",
});
const anthropicKey = onepassword.getItemOutput({
    vault: moltbotVault.uuid,
    title: "Anthropic API Key",
});

// Tailscale - Generate auth key for VM
const tailscaleKey = new tailscale.TailnetKey("moltbot-key", {
    reusable: false,
    ephemeral: true,
    preauthorized: true,
    tags: ["tag:moltbot"],
});

// Backblaze B2 - Bucket and scoped credentials
const b2Bucket = new backblaze.Bucket("moltbot-backup", {
    bucketName: "rwaltr-moltbot-backup",
    bucketType: "allPrivate",
});
const b2Key = new backblaze.ApplicationKey("moltbot-backup-key", {
    keyName: "moltbot-backup",
    capabilities: ["listBuckets", "readFiles", "writeFiles", "deleteFiles"],
    bucketId: b2Bucket.bucketId,
});

// Vultr - VM instance
const instance = new vultr.Instance("moltbot", {
    plan: "vc2-1c-2gb",
    region: "ewr",
    osId: 391,  // Fedora CoreOS
    userData: ignitionConfig,
});
```

### Quadlet Files: `infra/ucore/containers/`

| File | Purpose |
|------|---------|
| `moltbot-gateway.container` | Main Moltbot gateway service |
| `moltbot-backup.container` | Rclone backup to B2 |

### Butane Config: `infra/ucore/butane/hosts/moltbot-vultr.bu`

- Hostname
- Quadlet container definitions
- Tailscale authentication service
- Backup timer (hourly) + restore service
- Rebase to uCore on first boot

## Moltbot Configuration

### Sandbox with 1Password CLI

```json5
{
  "agents": {
    "defaults": {
      "sandbox": {
        "mode": "all",
        "scope": "agent",
        "workspaceAccess": "rw",
        "docker": {
          "image": "docker.io/clawdbot/clawdbot-sandbox-common:bookworm-slim",
          "network": "bridge",
          "memory": "2g",
          "cpus": 2,
          "setupCommand": "curl -sS https://downloads.1password.com/linux/keys/1password.asc | gpg --dearmor -o /usr/share/keyrings/1password-archive-keyring.gpg && echo 'deb [signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main' > /etc/apt/sources.list.d/1password.list && apt-get update && apt-get install -y 1password-cli",
          "env": {
            "OP_SERVICE_ACCOUNT_TOKEN": "${OP_SERVICE_ACCOUNT_TOKEN}"
          }
        }
      }
    }
  },
  "skills": {
    "entries": {
      "1password": {
        "enabled": true
      }
    }
  }
}
```

### Discord Configuration

```json5
{
  "channels": {
    "discord": {
      "enabled": true,
      "token": "${DISCORD_BOT_TOKEN}",
      "dmPolicy": "pairing",
      "groupPolicy": {
        "mentionRequired": true
      }
    }
  }
}
```

## Backup Strategy

| Trigger | When | Action |
|---------|------|--------|
| **Hourly timer** | `moltbot-backup.timer` | `rclone sync /var/moltbot b2:bucket` |
| **On shutdown** | `moltbot-shutdown-backup.service` | Backup before VM stops |
| **On boot** | `moltbot-restore.service` | Restore if `/var/moltbot/state` empty |

**Data durability:** Hourly backups = max 1 hour data loss. B2 provides 11 nines durability.

## First-Time Setup

```bash
# 1. Connect via Tailscale SSH
ssh core@moltbot.<tailnet>.ts.net

# 2. Check services
systemctl status moltbot-gateway.service

# 3. Run Moltbot onboarding (if needed)
podman exec -it moltbot-gateway moltbot onboard

# 4. Approve your Discord DM
podman exec moltbot-gateway moltbot pairing list discord
podman exec moltbot-gateway moltbot pairing approve discord <code>
```

## File Structure

```
infra/
├── pulumi/
│   └── vultr/
│       ├── Pulumi.yaml
│       ├── index.ts
│       ├── package.json
│       └── tsconfig.json
│
└── ucore/
    ├── butane/hosts/
    │   └── moltbot-vultr.bu
    ├── containers/
    │   ├── moltbot-gateway.container
    │   └── moltbot-backup.container
    └── docs/
        └── MOLTBOT-VULTR.md
```

## Operational Commands

```bash
# Service management
systemctl status moltbot-gateway.service
journalctl -u moltbot-gateway.service -f
systemctl restart moltbot-gateway.service

# Manual backup
systemctl start moltbot-backup.service

# Moltbot CLI
podman exec moltbot-gateway moltbot status
podman exec moltbot-gateway moltbot health

# Sandbox containers
podman ps -a --filter "name=clawdbot-sbx"
```

## Implementation Checklist

- [ ] **Pulumi Stack** (`infra/pulumi/vultr/`)
  - [ ] Vultr, Tailscale, B2, 1Password providers
  - [ ] VM instance, Tailscale key, B2 bucket + key
  - [ ] 1Password vault/item references
  - [ ] Output Ignition config with secrets

- [ ] **1Password Setup**
  - [ ] Create "moltbot" vault
  - [ ] Add: Discord Bot Token, Anthropic API Key, GitHub Token
  - [ ] Create service account `moltbot` with vault read access
  - [ ] Configure Pulumi: `pulumi config set onepassword:serviceAccountToken --secret`

- [ ] **GitHub Integration**
  - [ ] Create GitHub token for Moltbot (repo + PR permissions)
  - [ ] Store in 1Password moltbot vault
  - [ ] Document credential request PR workflow

- [ ] **Quadlet Definitions**
  - [ ] `moltbot-gateway.container`
  - [ ] `moltbot-backup.container`

- [ ] **Butane Config** (`moltbot-vultr.bu`)
  - [ ] Tailscale auth service
  - [ ] Backup timer (hourly) + restore service
  - [ ] uCore rebase service

- [ ] **Testing**
  - [ ] Vultr deployment
  - [ ] Discord connection
  - [ ] Sandbox + 1Password skill
  - [ ] Backup/restore cycle

## References

- [Moltbot Documentation](https://docs.clawd.bot/)
- [Vultr FCOS Provisioning](https://docs.fedoraproject.org/en-US/fedora-coreos/provisioning-vultr/)
- [Pulumi Vultr Provider](https://www.pulumi.com/registry/packages/vultr/)
- [Pulumi Tailscale Provider](https://www.pulumi.com/registry/packages/tailscale/)
- [Pulumi Backblaze Provider](https://www.pulumi.com/registry/packages/backblaze/)
- [Pulumi 1Password Provider](https://www.pulumi.com/registry/packages/onepassword/)
- [1Password Service Accounts](https://developer.1password.com/docs/service-accounts/)
- [Podman Quadlet](https://docs.podman.io/en/latest/markdown/podman-systemd.unit.5.html)
